<!DOCTYPE html>
<html>
	<head>
		<title>Reactive.coffee demo</title>
		<script type="text/javascript" src="../build/browser/reactive.js"></script>
		<script type="text/javascript" src="../build/browser/debuggee.js"></script>
		<script type="text/javascript">

			function SenderWidget() {
				this.input = new ElementModel('input', null, new DictModel({type: 'text'}));
				this.value = this.input.form_value(['keyup', 'paste']);
				var empty = this.value.map(function(v){v.length == 0}).distinct();
				var disabled = empty.map(function(e){return e ? 'disable' : ''})
				// TODO: this is a little too verbose... How to do something like android's xml files, or apple's nibs?
				this.sendButton = new ElementModel('button', new ListModel(new TextNode('Send')), new DictModel({disabled: disabled}));
				var val = this.value;
				this.sendEvents = sendButton.event_stream('click').map(function(evt){
					return new SendEvent(val.value);
				});
			}

			function SendEvent(msg) {
				this.msg = msg;
			}
			SendEvent.prototype.toString = function() {
				return "#<SendEvent msg='" + this.msg + "'>";
			}

			function Logger(stream) {
				var els = new ListModel();
				stream.observe(function(evt) {
					els.append(evt);
				});
				els.map() // LEfT OFF HERE
				this.list = new ElementModel('ul', )
			}

			BrowserEnvironment.instance().start.observe(function() {
				// env.from_event(window, 'load').observe(function() {
					console.log('initializing shit...');

					// do stuff with text field value...
					var formValue = env.from_form_value(document.getElementById('foo'), ['keyup', 'paste']);

					var empty = formValue.map(function(v){return v.length == 0});
					var disabled = empty.map(function(e){return e ? 'disable' : ''});
					env.bind_value(disabled, document.getElementById('send'), 'disabled')

					var windowTitle = formValue.map(function(v) { return v + (empty.value ? '' : ' | ') + 'Reactive Demo' });
					env.bind_value(windowTitle, document, 'title');

					// do stuff with clicks...
					var clicks = env.from_event(document.getElementById('send'), 'click');
					var clickCounter = clicks.fold(0, function(x, evt) { return x+1 });

					clicks.log('clicks');

					env.bind_value(clickCounter, document.getElementById('clickcounter'), 'innerText');

					// do stuff with timer...
					// var ticker = new Ticker(1000);
					// env.bind_value(ticker, document.getElementById('pagetimer'), 'innerText');

				// });
			});

			Debuggee.initialize('ws://localhost:8000/debuggee', BrowserEnvironment.instance())
							.andthen(function(){
								env.do_start();
							});
		</script>
	</head>
	<body>
			<input id="foo" type="text" value="foo"/>
			<button id="send">Send Message</button>
		<div>Clicks on sent button: <span id="clickcounter"></span></div>
		<div>Seconds spent on this page: <span id="pagetimer"></span></div>
	</body>
</html>
